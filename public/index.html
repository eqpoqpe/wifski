<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Wifski</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
		<style>
			body {
				font-family: 'Inter', sans-serif;
				background-color: #f3f4f6; /* gray-100 */
			}

			.dark body {
				background-color: #111827; /* gray-900 */
			}

			/* Custom styles for the dual-thumb slider */
			.slider-container {
				position: relative;
				height: 2rem;
			}

			.slider-track {
				position: absolute;
				height: 6px;
				background-color: #e5e7eb; /* gray-200 */
				width: 100%;
				top: 50%;
				transform: translateY(-50%);
				border-radius: 9999px;
				z-index: 1;
			}

			.dark .slider-track {
				background-color: #374151; /* gray-700 */
			}

			.slider-track-highlight {
				position: absolute;
				height: 6px;
				background-color: #3b82f6; /* blue-500 */
				top: 50%;
				transform: translateY(-50%);
				border-radius: 9999px;
				z-index: 2;
			}

			input[type='range'].slider {
				-webkit-appearance: none;
				appearance: none;
				position: absolute;
				width: 100%;
				height: 6px;
				top: 50%;
				transform: translateY(-50%);
				background: transparent;
				pointer-events: none;
				z-index: 3;
				margin: 0;
			}

			input[type='range'].slider::-webkit-slider-thumb {
				-webkit-appearance: none;
				appearance: none;
				width: 20px;
				height: 20px;
				background-color: white;
				border: 1px solid #d1d5db; /* gray-300 */
				border-radius: 50%;
				cursor: pointer;
				pointer-events: auto;
				box-shadow:
					0 1px 3px 0 rgb(0 0 0 / 0.1),
					0 1px 2px -1px rgb(0 0 0 / 0.1);
			}

			.dark input[type='range'].slider::-webkit-slider-thumb {
				background-color: #d1d5db; /* gray-300 */
				border-color: #4b5563; /* gray-600 */
			}

			input[type='range'].slider::-moz-range-thumb {
				width: 20px;
				height: 20px;
				background-color: white;
				border: 1px solid #d1d5db;
				border-radius: 50%;
				cursor: pointer;
				pointer-events: auto;
				box-shadow:
					0 1px 3px 0 rgb(0 0 0 / 0.1),
					0 1px 2px -1px rgb(0 0 0 / 0.1);
			}

			.dark input[type='range'].slider::-moz-range-thumb {
				background-color: #d1d5db;
				border-color: #4b5563;
			}

			.loader {
				border: 6px solid #e5e7eb; /* gray-200 */
				border-radius: 50%;
				width: 64px;
				height: 64px;
				animation: spin-colors 2s linear infinite;
			}

			.dark .loader {
				border-color: #374151;
			}

			@keyframes spin-colors {
				0% {
					transform: rotate(0deg);
					border-top-color: #3b82f6; /* blue-500 */
				}
				25% {
					border-top-color: #22c55e; /* green-500 */
				}
				50% {
					border-top-color: #eab308; /* yellow-500 */
				}
				75% {
					border-top-color: #ef4444; /* red-500 */
				}
				100% {
					transform: rotate(360deg);
					border-top-color: #3b82f6; /* blue-500 */
				}
			}
		</style>
	</head>
	<body class="text-gray-900 dark:text-gray-100">
		<div class="container mx-auto max-w-3xl p-4 sm:p-6 lg:p-8">
			<header class="text-center mb-10">
				<h1 class="text-4xl sm:text-5xl font-bold tracking-tight">Wifski</h1>
				<p class="text-lg text-gray-600 dark:text-gray-400 mt-2">Create high-quality GIFs from your videos on the web.</p>
			</header>

			<main class="space-y-8">
				<!-- Step 1: File Upload -->
				<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
					<h2 class="text-2xl font-semibold mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">1. Select Video</h2>
					<label
						for="video-input"
						class="relative flex flex-col items-center justify-center w-full h-48 border-2 border-dashed rounded-lg cursor-pointer bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 border-gray-300 dark:border-gray-600 transition-colors"
					>
						<div class="text-center">
							<svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
								<path
									d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8"
									stroke-width="2"
									stroke-linecap="round"
									stroke-linejoin="round"
								/>
							</svg>
							<p class="mt-1 text-sm text-gray-600 dark:text-gray-300">
								<span class="font-semibold text-blue-600">Click to upload</span> or drag and drop
							</p>
							<p id="file-name" class="mt-1 text-xs text-gray-500 dark:text-gray-400"></p>
						</div>
						<input id="video-input" type="file" class="sr-only" accept="video/*" />
					</label>
					<p class="text-xs text-gray-500 dark:text-gray-400 text-center mt-2">Max file size: 100MB</p>
				</div>

				<form id="conversion-form" class="hidden space-y-8">
					<!-- Step 2: Trim Video -->
					<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
						<h2 class="text-2xl font-semibold mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">2. Trim Video</h2>
						<video id="video-preview" class="w-full rounded-lg bg-black mb-4" controls></video>

						<div class="slider-container my-4">
							<div class="slider-track"></div>
							<div id="slider-highlight" class="slider-track-highlight"></div>
							<input type="range" class="slider" id="start-slider" value="0" min="0" step="0.1" />
							<input type="range" class="slider" id="end-slider" value="100" min="0" step="0.1" />
						</div>

						<div class="flex justify-between items-center text-sm font-mono">
							<span id="start_time_display">00:00:00</span>
							<span id="end_time_display">00:00:00</span>
						</div>
					</div>

					<!-- Step 3: Conversion Options -->
					<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
						<h2 class="text-2xl font-semibold mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">3. Options</h2>
						<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
							<div>
								<label for="resize" class="block text-sm font-medium">Resize</label>
								<select
									id="resize"
									name="resize"
									class="mt-1 block w-full p-2 border rounded-md bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500"
								>
									<option value="100" selected>100% (Original)</option>
									<option value="75">75%</option>
									<option value="50">50%</option>
									<option value="25">25%</option>
								</select>
							</div>
							<div>
								<label for="speed" class="block text-sm font-medium">Speed</label>
								<select
									id="speed"
									name="speed"
									class="mt-1 block w-full p-2 border rounded-md bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500"
								>
									<option value="1.0" selected>1x</option>
									<option value="2.0">2x</option>
									<option value="3.0">3x</option>
									<option value="4.0">4x</option>
									<option value="5.0">5x</option>
								</select>
							</div>
							<div>
								<label for="fps" class="block text-sm font-medium">FPS (3-10)</label>
								<input
									type="number"
									id="fps"
									name="fps"
									value="8"
									min="3"
									max="10"
									class="mt-1 block w-full p-2 border rounded-md bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500"
								/>
							</div>
							<div>
								<label for="quality" class="block text-sm font-medium">Quality (0-100)</label>
								<input
									type="number"
									id="quality"
									name="quality"
									value="75"
									min="0"
									max="100"
									class="mt-1 block w-full p-2 border rounded-md bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500"
								/>
							</div>
							<div class="md:col-span-2">
								<label for="loop" class="block text-sm font-medium">Loop</label>
								<select
									id="loop"
									name="loop"
									class="mt-1 block w-full p-2 border rounded-md bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500"
								>
									<option value="forever" selected>Loop Forever</option>
									<option value="bounce">Bounce</option>
								</select>
							</div>
						</div>
					</div>

					<!-- Submit Button -->
					<div class="text-center">
						<button
							type="submit"
							class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
						>
							Create GIF
						</button>
					</div>
				</form>

				<!-- Step 4: Result -->
				<div id="result-section" class="hidden text-center bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
					<div id="loader" class="hidden flex flex-col items-center justify-center">
						<div class="loader"></div>
						<p class="mt-4 text-gray-600 dark:text-gray-400">Converting your video...</p>
					</div>
					<div id="gif-container" class="hidden">
						<h2 class="text-2xl font-semibold mb-4">Your GIF is Ready!</h2>
						<img id="gif-preview" class="w-full max-w-md mx-auto rounded-lg shadow-lg mb-6" alt="Converted GIF" />
						<a
							id="download-button"
							href="#"
							download="converted.gif"
							class="inline-block bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
						>
							Download GIF
						</a>
					</div>
					<div
						id="error-container"
						class="hidden bg-red-100 dark:bg-red-900/20 border border-red-400 text-red-700 dark:text-red-300 px-4 py-3 rounded-lg relative"
					>
						<strong class="font-bold">Conversion Failed!</strong>
						<span class="block sm:inline">Something went wrong. Please check your settings and try again.</span>
					</div>
				</div>
			</main>
		</div>

		<footer class="text-center py-6">
			<p class="text-sm text-gray-500 dark:text-gray-400">
				Built with 🧡 using
				<a href="https://developers.cloudflare.com/workers/" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline"
					>Cloudflare Workers</a
				>
				—
				<a href="https://github.com/megaconfidence/wifski" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline"
					>👀 the code</a
				>
			</p>
		</footer>

		<script>
			document.addEventListener('DOMContentLoaded', function () {
				const videoInput = document.getElementById('video-input');
				const fileNameDisplay = document.getElementById('file-name');
				const conversionForm = document.getElementById('conversion-form');
				const videoPreview = document.getElementById('video-preview');

				const startSlider = document.getElementById('start-slider');
				const endSlider = document.getElementById('end-slider');
				const startTimeDisplay = document.getElementById('start_time_display');
				const endTimeDisplay = document.getElementById('end_time_display');
				const sliderHighlight = document.getElementById('slider-highlight');

				const resultSection = document.getElementById('result-section');
				const loader = document.getElementById('loader');
				const gifContainer = document.getElementById('gif-container');
				const errorContainer = document.getElementById('error-container');
				const gifPreview = document.getElementById('gif-preview');
				const downloadButton = document.getElementById('download-button');

				let videoFile = null;
				const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB

				videoInput.addEventListener('change', (e) => {
					if (e.target.files && e.target.files[0]) {
						const selectedFile = e.target.files[0];

						if (selectedFile.size > MAX_FILE_SIZE) {
							alert('File is too large. Please select a file under 100MB.');
							videoInput.value = ''; // Clear the input
							fileNameDisplay.textContent = '';
							conversionForm.classList.add('hidden');
							return;
						}

						videoFile = selectedFile;
						fileNameDisplay.textContent = videoFile.name;
						const fileURL = URL.createObjectURL(videoFile);
						videoPreview.src = fileURL;
						conversionForm.classList.remove('hidden');
						resultSection.classList.add('hidden');
					}
				});

				videoPreview.addEventListener('loadedmetadata', () => {
					const duration = videoPreview.duration;
					startSlider.max = duration;
					endSlider.max = duration;
					startSlider.value = 0;
					endSlider.value = duration;
					startTimeDisplay.textContent = formatTimeHHMMSS(0);
					endTimeDisplay.textContent = formatTimeHHMMSS(duration);
					updateSliderHighlight();
				});

				function updateSliderHighlight() {
					const max = parseFloat(startSlider.max);
					const start = parseFloat(startSlider.value);
					const end = parseFloat(endSlider.value);

					sliderHighlight.style.left = `${(start / max) * 100}%`;
					sliderHighlight.style.width = `${((end - start) / max) * 100}%`;
				}

				function formatTimeHHMMSS(seconds) {
					if (isNaN(seconds) || seconds < 0) {
						return '00:00:00';
					}
					return new Date(seconds * 1000).toISOString().substr(11, 8);
				}

				startSlider.addEventListener('input', () => {
					if (parseFloat(startSlider.value) >= parseFloat(endSlider.value)) {
						startSlider.value = parseFloat(endSlider.value) - 0.1;
					}
					startTimeDisplay.textContent = formatTimeHHMMSS(startSlider.value);
					updateSliderHighlight();
				});

				endSlider.addEventListener('input', () => {
					if (parseFloat(endSlider.value) <= parseFloat(startSlider.value)) {
						endSlider.value = parseFloat(startSlider.value) + 0.1;
					}
					endTimeDisplay.textContent = formatTimeHHMMSS(endSlider.value);
					updateSliderHighlight();
				});

				conversionForm.addEventListener('submit', async (e) => {
					e.preventDefault();
					if (!videoFile) {
						alert('Please select a video file first.');
						return;
					}

					resultSection.classList.remove('hidden');
					loader.classList.remove('hidden');
					gifContainer.classList.add('hidden');
					errorContainer.classList.add('hidden');

					// Scroll to the loader as soon as the button is clicked
					resultSection.scrollIntoView({ behavior: 'smooth' });

					const formData = new FormData(conversionForm);
					formData.append('video', videoFile);

					formData.append('start_time', parseFloat(startSlider.value).toFixed(1));
					formData.append('end_time', parseFloat(endSlider.value).toFixed(1));

					try {
						const response = await fetch('/convert', {
							method: 'POST',
							body: formData,
						});

						if (!response.ok) {
							throw new Error(`Server responded with status: ${response.status}`);
						}

						const blob = await response.blob();
						const gifUrl = URL.createObjectURL(blob);
						gifPreview.src = gifUrl;
						downloadButton.href = gifUrl;

						loader.classList.add('hidden');
						gifContainer.classList.remove('hidden');
					} catch (error) {
						console.error('Conversion failed:', error);
						loader.classList.add('hidden');
						errorContainer.classList.remove('hidden');
					} finally {
						// Scroll again when the process completes to ensure visibility
						resultSection.scrollIntoView({ behavior: 'smooth' });
					}
				});
			});
		</script>
	</body>
</html>
